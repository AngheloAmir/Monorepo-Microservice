<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex items-center justify-center overflow-hidden">

    <!-- Login View -->
    <div id="login-view" class="w-full max-w-sm bg-gray-800 p-8 rounded-xl border border-gray-700 shadow-2xl">
        <h2 class="text-2xl font-bold mb-6 text-center text-blue-400">Login to Chat</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-xs text-gray-400 mb-1">Server URL (Optional)</label>
                <input type="text" id="server-url" placeholder="Auto-connect (Empty) or http://localhost:8081" class="w-full bg-gray-900 border border-gray-600 rounded p-2 focus:border-blue-500 outline-none text-white text-xs font-mono">
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">Username</label>
                <input type="text" id="username" value="test" class="w-full bg-gray-900 border border-gray-600 rounded p-2 focus:border-blue-500 outline-none text-white">
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">Password</label>
                <input type="password" id="password" value="test" class="w-full bg-gray-900 border border-gray-600 rounded p-2 focus:border-blue-500 outline-none text-white">
            </div>
            <button onclick="attemptLogin()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded transition">
                Enter Chat
            </button>
            <p id="error-msg" class="text-red-400 text-xs text-center h-4"></p>
        </div>
    </div>

    <!-- Chat View (Hidden) -->
    <div id="chat-view" class="hidden w-full max-w-md h-[600px] bg-gray-800 rounded-xl border border-gray-700 shadow-2xl flex flex-col overflow-hidden">
        <!-- Header -->
        <div class="p-4 border-b border-gray-700 bg-gray-900/50 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div id="connection-dot" class="w-2 h-2 rounded-full bg-gray-500"></div>
                <span class="font-bold">Socket Chat</span>
                <span id="connection-status" class="text-xs text-gray-500 font-normal ml-2">Connecting...</span>
            </div>
            <button onclick="window.location.reload()" class="text-xs text-gray-500 hover:text-white">Logout</button>
        </div>

        <!-- Messages Area -->
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-gray-600">
            <!-- Messages will appear here -->
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-700 bg-gray-900/50 flex gap-2">
            <input type="text" id="msg-input" placeholder="Type a message..." 
                class="flex-1 bg-gray-900 border border-gray-600 rounded px-3 py-2 focus:border-blue-500 outline-none text-sm"
                onkeypress="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-500 text-white rounded px-4 transition">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        let socket = null;
        let isLoggedIn = false;

        // --- Login Logic ---
        function attemptLogin() {
            const serverUrl = document.getElementById('server-url').value.trim();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;

            // Simple check
            if (user === 'test' && pass === 'test') {
                isLoggedIn = true;
                
                // Initialize Socket with specific URL or Default (null)
                // If serverUrl is empty string, io() connects to current host.
                // If serverUrl is "http://localhost:8081", it connects there.
                socket = io(serverUrl || undefined);

                setupSocketEvents(user);

                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('chat-view').classList.remove('hidden');
                
                addSystemMessage(`Welcome, ${user}! Connecting to ${serverUrl || 'local server'}...`);
                
            } else {
                document.getElementById('error-msg').textContent = "Invalid credentials. Try test/test";
            }
        }

        // --- Setup Listeners (Run after Init) ---
        function setupSocketEvents(user) {
            const statusText = document.getElementById('connection-status');
            const statusDot = document.getElementById('connection-dot');

            socket.on('connect', () => {
                 statusDot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                 statusText.innerText = "Connected";
                 statusText.className = "text-xs text-green-400 font-normal ml-2";
                 
                 // Authenticate/Join after connection
                 socket.emit('join-chat', user);
            });

            socket.on('disconnect', () => {
                 statusDot.className = "w-2 h-2 rounded-full bg-red-500";
                 statusText.innerText = "Disconnected";
                 statusText.className = "text-xs text-red-400 font-normal ml-2";
            });

            socket.on('server-message', (data) => {
                addMessage(data.text, 'server');
            });
        }

        // --- Chat Logic ---
        function sendMessage() {
            if (!socket || !socket.connected) return;
            
            const input = document.getElementById('msg-input');
            const txt = input.value.trim();
            if(!txt) return;

            // Add my message to UI
            addMessage(txt, 'me');
            
            // Send to server
            socket.emit('chat-message', txt);
            
            input.value = '';
        }

        // --- UI Helpers ---
        function addMessage(text, sender) {
            const div = document.createElement('div');
            const isMe = sender === 'me';
            
            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `
                <div class="max-w-[80%] rounded-lg px-3 py-2 text-sm ${
                    isMe 
                    ? 'bg-blue-600 text-white rounded-br-none' 
                    : 'bg-gray-700 text-gray-200 rounded-bl-none'
                }">
                    ${text}
                </div>
            `;
            
            const container = document.getElementById('messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = "text-center text-xs text-gray-500 my-2";
            div.innerText = text;
            document.getElementById('messages').appendChild(div);
        }

    </script>
</body>
</html>
