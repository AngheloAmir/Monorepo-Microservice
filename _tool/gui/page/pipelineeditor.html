<div class="h-full flex flex-col bg-gray-900 text-white overflow-hidden font-sans">
    <div class="border-b border-gray-800 p-6 flex justify-between items-center bg-gray-950/50 backdrop-blur-md">
        <div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-teal-400 to-blue-500 bg-clip-text text-transparent">Pipeline Script Editor</h1>
            <p class="text-gray-500 text-sm mt-1">Configure build and deploy scripts per workspace</p>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="window.PipelineEditor.refresh()" class="p-2 bg-gray-800 rounded-lg hover:bg-gray-700 hover:text-white text-gray-400 transition-colors">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <div class="flex-1 flex overflow-hidden">
        <!-- Sidebar List -->
        <div class="w-1/4 border-r border-gray-800 bg-gray-900/50 flex flex-col overflow-hidden">
             <div class="p-4 border-b border-gray-800">
                 <input type="text" id="pe-search" placeholder="Search workspaces..." 
                     class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm text-white focus:outline-none focus:border-teal-500">
             </div>
             <div id="pe-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                 <!-- List Items -->
             </div>
        </div>

        <!-- Editor Area -->
        <div class="flex-1 flex flex-col bg-gray-900 relative">
            <div id="pe-empty" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500">
                <i class="fas fa-code-branch text-6xl mb-4 opacity-20"></i>
                <p>Select a workspace to edit scripts</p>
            </div>

            <div id="pe-editor" class="hidden flex-col h-full">
                <!-- Toolbar -->
                <div class="h-14 border-b border-gray-800 flex items-center px-6 justify-between bg-gray-900">
                    <div class="flex items-center gap-3">
                        <div id="pe-icon" class="w-8 h-8 rounded bg-gray-800 flex items-center justify-center text-gray-400"></div>
                        <h2 id="pe-title" class="text-lg font-bold">Workspace</h2>
                    </div>
                </div>

                <!-- Scripts Grid -->
                <div class="flex-1 overflow-y-auto p-8">
                    <div class="max-w-4xl mx-auto grid grid-cols-1 gap-6">
                        
                        <!-- Build Script -->
                        <div class="script-card group">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold uppercase tracking-wider text-purple-400">Build Command</label>
                                <span class="text-[10px] text-gray-600">npm run build</span>
                            </div>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-hammer text-gray-500 text-sm"></i>
                                </div>
                                <input type="text" id="script-build" 
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-10 pr-24 py-3 text-sm font-mono text-white focus:outline-none focus:border-purple-500 transition-colors"
                                    placeholder="e.g. vite build">
                                <button onclick="window.PipelineEditor.save('build')" 
                                    class="absolute right-2 top-1.5 px-3 py-1.5 bg-purple-600/20 text-purple-400 hover:bg-purple-600 hover:text-white rounded text-xs font-bold transition-all">
                                    SAVE
                                </button>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">The command Turbo runs to compile your app.</p>
                        </div>

                        <!-- Deploy Script -->
                         <div class="script-card group">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold uppercase tracking-wider text-green-400">Deploy Command</label>
                                <span class="text-[10px] text-gray-600">npm run deploy</span>
                            </div>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-cloud-upload-alt text-gray-500 text-sm"></i>
                                </div>
                                <input type="text" id="script-deploy" 
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-10 pr-24 py-3 text-sm font-mono text-white focus:outline-none focus:border-green-500 transition-colors"
                                    placeholder="e.g. vercel deploy --prod">
                                <button onclick="window.PipelineEditor.save('deploy')" 
                                    class="absolute right-2 top-1.5 px-3 py-1.5 bg-green-600/20 text-green-400 hover:bg-green-600 hover:text-white rounded text-xs font-bold transition-all">
                                    SAVE
                                </button>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">The command to publish your build artifacts.</p>
                        </div>
                        
                        <!-- Helper Tools -->
                        <div class="mt-8 border-t border-gray-800 pt-8">
                             <h3 class="text-sm font-bold text-gray-400 mb-4">Deployment Snippets</h3>
                             <div class="grid grid-cols-2 gap-4">
                                 <button onclick="window.PipelineEditor.applySnippet('vercel')" class="p-3 border border-gray-700 rounded-lg hover:bg-gray-800 flex items-center gap-3 text-left">
                                     <div class="w-8 h-8 rounded bg-black flex items-center justify-center"><i class="fas fa-triangle text-white"></i></div>
                                     <div>
                                         <div class="text-xs font-bold text-white">Vercel</div>
                                         <div class="text-[10px] text-gray-500">Deploy to Serverless</div>
                                     </div>
                                 </button>
                                 <button onclick="window.PipelineEditor.applySnippet('s3')" class="p-3 border border-gray-700 rounded-lg hover:bg-gray-800 flex items-center gap-3 text-left">
                                     <div class="w-8 h-8 rounded bg-orange-500/20 flex items-center justify-center"><i class="fab fa-aws text-orange-500"></i></div>
                                     <div>
                                         <div class="text-xs font-bold text-white">AWS S3</div>
                                         <div class="text-[10px] text-gray-500">Deploy Static Site</div>
                                     </div>
                                 </button>
                             </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    window.PipelineEditor = {
        workspaces: [],
        currentWs: null,

        init: async function() {
            await this.refresh();
            
            // Search listener
            document.getElementById('pe-search').addEventListener('input', (e) => {
                this.renderList(e.target.value);
            });
        },

        refresh: async function() {
            try {
                const res = await fetch('/api/activepipeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get-workspaces' })
                });
                const data = await res.json();
                this.workspaces = data.workspaces || [];
                this.renderList();
            } catch(e) {
                console.error(e);
            }
        },

        renderList: function(filter = '') {
            const list = document.getElementById('pe-list');
            list.innerHTML = '';
            
            this.workspaces.forEach(ws => {
                if (filter && !ws.name.toLowerCase().includes(filter.toLowerCase())) return;
                
                const isActive = this.currentWs && this.currentWs.name === ws.name;
                const activeClass = isActive ? 'bg-teal-500/10 border-teal-500/50' : 'border-transparent hover:bg-gray-800';
                
                const el = document.createElement('div');
                el.className = `p-3 rounded-lg border cursor-pointer group flex items-center gap-3 transition-all ${activeClass}`;
                el.onclick = () => this.selectWorkspace(ws);
                el.innerHTML = `
                    <div class="w-8 h-8 rounded bg-gray-800 flex items-center justify-center text-gray-400 group-hover:text-white transition-colors">
                        <i class="${ws.icon || 'fas fa-box'}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-bold text-gray-200 group-hover:text-white truncate">${ws.name}</div>
                        <div class="text-[10px] text-gray-600 truncate">${ws.type || 'package'}</div>
                    </div>
                `;
                list.appendChild(el);
            });
        },

        selectWorkspace: function(ws) {
            this.currentWs = ws;
            this.renderList(document.getElementById('pe-search').value);
            
            document.getElementById('pe-empty').classList.add('hidden');
            document.getElementById('pe-editor').classList.remove('hidden');
            document.getElementById('pe-editor').classList.add('flex');

            document.getElementById('pe-title').textContent = ws.name;
            document.getElementById('pe-icon').innerHTML = `<i class="${ws.icon || 'fas fa-box'}"></i>`;
            
            // Populate inputs
            const scripts = ws.scripts || {};
            document.getElementById('script-build').value = scripts.build || '';
            document.getElementById('script-deploy').value = scripts.deploy || '';
        },

        save: async function(scriptKey) {
            if (!this.currentWs) return;
            
            const input = document.getElementById(`script-${scriptKey}`);
            const cmd = input.value;
            
            // Visual feedback
            const btn = input.nextElementSibling;
            const originalText = btn.textContent;
            btn.textContent = '...';
            
            try {
                const res = await fetch('/api/activepipeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'save-script',
                        workspacePath: this.currentWs.path,
                        scriptName: scriptKey,
                        command: cmd
                    })
                });
                
                if (res.ok) {
                    btn.textContent = 'SAVED';
                    btn.classList.add('bg-green-500', 'text-white');
                    setTimeout(() => {
                         btn.textContent = originalText;
                         btn.classList.remove('bg-green-500', 'text-white');
                         
                         // Update local cache
                         if (!this.currentWs.scripts) this.currentWs.scripts = {};
                         this.currentWs.scripts[scriptKey] = cmd;
                    }, 1000);
                }
            } catch(e) {
                alert('Save failed');
            }
        },

        applySnippet: function(type) {
             if (!this.currentWs) return;
             const deployInput = document.getElementById('script-deploy');
             
             if(type === 'vercel') {
                 deployInput.value = 'vercel deploy --prod';
             } else if (type === 's3') {
                 deployInput.value = 'aws s3 sync dist/ s3://my-bucket --region us-east-1';
             }
        }
    };

    window.PipelineEditor.init();
</script>
