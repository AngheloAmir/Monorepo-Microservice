# Shared Models Tutorial

This guide explains how to use the `@monorepo/models` package, which houses the shared Prisma schema, database client, and generated types for the monorepo.

## 1. Overview

The `shared/models` package exports:
- A singleton **PrismaClient** instance (`prisma`) to ensure a single database connection.
- All **Types** generated by Prisma (e.g., `User`, `Post`, `Prisma.UserCreateInput`).

## 2. Prerequisites

### Environment Variables
You must have a `.env` file in the root of your application (or the workspace where you run scripts) containing the `DATABASE_URL`.

```env
DATABASE_URL="postgresql://user:password@localhost:5432/mydb?schema=public"
```

## 3. Installation & Setup

### Using in a Workspace
To use the models in a backend service, API, or frontend application, add the dependency to that workspace's `package.json`:

```json
"dependencies": {
  "@monorepo/models": "*"
}
```

Then run `npm install` from the monorepo root.

### Generating the Client
Whenever you update the schema, you must regenerate the Prisma client. The `shared/models` package has a script for this.

From the root of the monorepo, you can run:

```bash
turbo run db:generate
```
Or go into `shared/models` and run:
```bash
npm run db:generate
```

## 4. Database Management

Scripts are defined in `shared/models/package.json`.

| Command | Description | Usage |
| :--- | :--- | :--- |
| `npm run db:generate` | Generates the Prisma Client JS. Run this after installation or schema changes. | `turbo run db:generate` |
| `npm run db:push` | Pushes the state of your Prisma schema file to the database without creating a migration. Great for prototyping. | `cd shared/models && npm run db:push` |
| `npm run db:migrate` | Creates a migration from changes in Prisma schema, applies it to the database, and triggers generation. Use this for production-ready changes. | `cd shared/models && npm run db:migrate` |
| `npm run db:studio` | Opens a generic GUI to view and edit data in your database. | `cd shared/models && npm run db:studio` |

### Adding New Models
The schema is split into multiple files in the `prisma/schema` directory.
1. Create a new `.prisma` file in `shared/models/prisma/schema/` (e.g., `product.prisma`).
2. Define your model:
   ```prisma
   model Product {
     id    String @id @default(cuid())
     name  String
     price Int
   }
   ```
3. Run `npm run db:generate` (and `db:push` or `db:migrate` to update the DB).

## 5. Usage Examples

### Backend (Node.js / API Routes / Server Actions)

You can import the pre-configured `prisma` instance directly. This instance is a singleton, preventing "too many connections" errors during development.

```typescript
// apps/api/src/index.ts or apps/web/app/actions.ts
import { prisma } from '@monorepo/models';

async function main() {
  // Create a user
  const newUser = await prisma.user.create({
    data: {
      email: 'hello@example.com',
      name: 'Alice',
    },
  });

  // Query users
  const users = await prisma.user.findMany({
    include: { posts: true },
  });

  console.log(users);
}
```

### Frontend (Types Only)

**Important:** You generally **cannot** use the `prisma` client directly in client-side code (browser) because it requires Node.js bindings and contains secrets.

However, you *should* import the **types** to ensure type safety in your frontend components when handling data returned from an API.

```typescript
// apps/web/components/UserList.tsx
import type { User } from '@monorepo/models';

interface UserListProps {
  users: User[];
}

export const UserList = ({ users }: UserListProps) => {
  return (
    <ul>
      {users.map((user) => (
        <li key={user.id}>
          {user.name} ({user.email})
        </li>
      ))}
    </ul>
  );
};
```

### Sharing Types (DTOs)

If you need specific utility types generated by Prisma, they are also available:

```typescript
import type { Prisma } from '@monorepo/models';

// Type for the input used to create a User
const userData: Prisma.UserCreateInput = {
    email: 'test@test.com',
    name: 'Test User'
};
```
